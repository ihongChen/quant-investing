# ModERP_v1

### 品陞的問題

我是先從台股基本分析下手，由於基本分析策略長期持有的特性，交易次數較少，技術門檻也較低。想和你討論實作過程中的發現與問題（附件是該策略每筆的交易資料）：

1. 在步驟 8 中利用 [MAE 與 Profit-Loss 的頻率圖](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g42f9e08b6c_0_464)，找出策略最佳的停損點，感覺應該可以用 regression 或者有演算法直接求出最佳解？
2. 但我直覺認為取得最佳淨利率的停損點並不就代表最好，我有在回測框架中實作[策略診斷指標](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g43a1b5de6e_1_128)，想請問如果策略指標的數值皆在你提出的[合理範圍](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g43a1b5de6e_1_128)內，決定停損點位的 SOP 是？
3. 做回測時，是否需要保留一部分測試資料（Maybe 最近一年），以避免上述策略調整後 overfitting。
4. 像我用基本分析、回測時也是抓回測當日及去年同季的財報資料，還需要用滾動回測嗎？

</br>

下面和你請教在簡報中比較不清楚的部分：

1. 從 [p109](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g42f9e08b6c_0_578) 開始畫的系列 MAE 頻率圖，應該是多組交易的統計結果？裡面只有 Losers MAE 還是包含 Winners MAE 呢？

2. [p122 MAE 對 MFE 圖與 P&L 曲線](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g42f9e08b6c_0_1021) 怎麼辦到的，拜託教我 QQ

3. [p126 MAE 對 MFE 圖](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g42f9e08b6c_0_1116)，感覺比較進階，是 [MAE 與 Profit-Loss 的分佈圖](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g42f9e08b6c_0_206)、[頻率圖](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g42f9e08b6c_0_481) 都分析過後，還是找不到合適的停損點，才來看 [MAE 對 MFE 圖](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g42f9e08b6c_0_1116) 嗎？還是說是為了決定停利點？

4. [p17](https://docs.google.com/presentation/d/1o-tSWGh-a2JgPtHuMXWr4fT5KMUAK9CzaWqWDJnW5Ng/edit#slide=id.g4461181d5a_0_17)，演講中有提到若用 Supervised Learning 來預測標的物價格，可以修改 loss function，若預測的結果導致交易損失則放大 loss、反之則縮小。這樣可以理解為 Model 的目標不單單只是為了降低預測數值與實際價格的誤差、還包含交易的勝手率。但是，這樣和 Reinforcement Learning train 出來的 Model 效果會有什麼不同嗎 @@

</br>

### 睿麒的答覆

我先大致提一下對你的 GitHub 上初步成果的見解，然後後續回答你的各個問題。

因為你做股票，然後交易次數可能相對較少，所以我會先看你的**交易次數**，由於你每次 build 的投資組合有相依關係，所以你的交易次數也不能完全做參考，可能也要打個折（我不太確定）。

不過這可能也沒辦法，因為你就是根據財報去挑，所以你的決定訊號的時間（也就是我投影片中的 Pure Signal 時間）非常少。

</br>

**第 1 - 5 點（選股策略）**

因為你的交易次數非常少，或是因為交易標的/交易方法的特性的關係，所以我首先要先特別請你多留意，你的各種交易指標可能不夠有穩健性，儘管你已經回測了 4 年，所以我對你的幾個基本指標會要求比較高。

</br>

**第 6 點（發布日再平衡，final）**

例如 Win Ratio 我覺得就太低，你如果持有這麼長，你應該是有辦法中間拉到 Breakeven Stop 或是放比較大範圍的限價單（MAE Q2 ~ Q3），來製造更高的 Win Ratio。

關於 Profit Factor 我覺得算是不錯的數字，但交易量還是太少，但以財報分析的方法來說，在我印象中能上 2 的真的不多，我覺得下一步你可以做加減碼，到時候數字會下來。

關於 Recovery Factor 的 13 我覺得參考性不大，交易量不高，不過這可能是【財報中潛力的跌深反彈】的特徵，也就是你有找到一些潛力股的特徵。

如果是用這種角度思考，我覺得會蠻有趣的，如果你跑你提到的策略在更寬鬆的條件，或是跑不同時間區間，或是不同市場，我蠻好奇這個方法是否會有固定的一個 Recovery Factor 的水準？

如果都有一個基礎的 Recovery Factor 的水準，再來衡量這個 13 會比較好，不過我認為這個參考意義真的不大，你可能要加減碼才能讓這個數字變小。

**我猜測可能每個交易結果的數字都要根據選股策略的基準做一些微調（我不確定是要直接扣，還是乘以一個乘數打折扣/放大參考，這是一個有意思的題目）**

Sharpe Ratio 還不錯，不過股票市場可能要求比較高，不過能過 0.25/0.3 以上就算不錯了，看 Sharpe 基本上不太受交易次數影響，但它的價值必須建立在許多前面的前提（Profit Factor，Recovery Factor ... etc）都過才有用。

</br>

**第 7 點（MAE - Profit/Loss 圖）**

這邊要特別提到，你的 MAE 是用趴數來判斷，基本上沒問題，但就是要留意不同標的他的基本波動水準可能還是和價格有關。

例如 20 塊的股票可能每日波動 2-5 塊，100 塊的股票可能每日波動也是 2-5 塊，但這兩個趴數不太一樣，在越小的時間尺度越推薦用價格。

但因為你持有蠻久的，所以其實用趴數是好的。

目前看起來蠻健康的，但因為你持有太久，我傾向於你可能不應該在停損上下功夫，應該是要用移動停損，因為靜態停損對你幫助可能不大。

因為你交易量太少，你有大量損益接近 0 的部分才是真正造成你停損放在 0.15，我傾向你停損應該放在 0.05 上面一點，然後把 0.05 ~ 0.15 的部分看移動停損能不能解決。

**要嘛就讓他更早死，不然你讓他拖累你整個策略，使得停損不能縮更小的話，你的停損沒太大用處。**

![image.png](https://i.imgur.com/pElbPz7.png)

所以你 7 之後其實幫助不大，我覺得這還要看你的 MAE / MFE 的圖才能討論，不過 7 做出來沒太大幫助是蠻合理的。

</br>

**第八點 -（MAE & Profit/Loss 頻率圖）**

我覺得這就是一個非常非常好的例子，你把我的方法搬過來沒有立即產生效果的原因。

因為你有太多交易的 MAE 水深太高，最後只輸一點點，我前面的紅色三角形就是這邊這塊，你應該是放在我畫的這邊。

（不怪你，因為我沒有講太多移動停損和損益兩平停損）

![image.png](https://i.imgur.com/YUJu1sj.png)

我覺得大概幫助也不大，蠻合理的。

</br>

**現階段狀況：**

我覺得後續你立即需要的是計算 MFE，我得知道你吃那麼深水深的交易，是被 Trend 打臉（低 MFE），還是說其實中間有賺錢的機會（高MFE）才能判斷我拉你的 Stoploss 到 0.05 左右合不合理，所以首先你就是要立即計算 MFE 。

我猜測你的 MAE 對 MFE 圖應該會蠻特殊的，我猜測可能是雙峰，因為你持有時間太長，可能已經在一個交易週期中經歷了兩輪大的波動變化，如果是這樣，移動停損 or 加減碼應該是有用的。

看完 MAE MFE 資料後，我可以再給你更多建議，如果你實務上因為資金問題加減碼不適用，我傾向於把你的 Win Ratio 拉到 0.7 以上，這樣你實戰只要 Win Ratio 不高，或是頻頻損益兩平出場，你就可以把策略停掉重新調整最基本的參數，這大概是我目前直接看反應出來的想法。

我可能再沉澱幾天又會有新想法，if then 我再回信給你，不過我覺得應該還是要看 MFE 才知道。

</br>

**※      ※      ※**     

接著回答你的問題

**1. 可以用 regression 或演算法直接根據 MAE 找出 stoploss/takeprofit 最佳解？**

**針對你的 Case**

基本上你是對的，這個最大的問題就是在隨機波動的市場特徵下，他可能不是一個持久存在的固定數字。

尤其是你如果還有換股，不同股票之間可能波動情形也不一樣，MAE 可以綜合考慮也可以分開考慮。

目前看你回測狀況是你經歷了兩輪在換股策略時的不同波動，分別是 2015.5 左右和最近 2017.7 左右。

所以我覺得至少你可以有兩步到三步的停損（分別先放大一點的停損，然後過一段時間拉到小波動的停損，然後再拉到損益兩平... if 有用）

</br>

**具體來說我怎麼做 MAE**

基本上我不太會用 Regression 因為滾動去做的時候差異還蠻大的，我會是用 Ensemble（組合式）的方式去做。

例如我可能會分成兩種不同交易水準，這兩種交易水準分別可能用 SVM（我就覺得蠻夠了，K-Mean 有時候也很夠了）

然後滾動過程中我就會在每次的訓練級分出不同水準的 MAE 做分別的估計合適的 Stop Loss，假設分了三組 G1 G2 G3，我會再把 G1 G2 G3 的權重用滾動式去找出一個比較合適的 constant，例如我的 stoploss 應該是 G1 估計出的 SL * 0.2 + G2 SL * 0.5 + G3 SL * 0.7。

當然我還有更複雜的演算法，不過基本概念大概是這樣。

</br>

**2. 決定停損點位的 SOP** 

你大概聽完我前面和你講的東西，大概可以理解決定 stoploss 的 SOP 可以很簡單也可以很複雜。

併發症越多的症狀，這刀會越不好開，像你的狀況就是已經和我投影片中講得種況在複雜一點，但還是可以處理

不過原則上有幾個步驟：

(1) 打噴嚏：先單看 MAE（也就是 MAE 對 Profit/Loss）

(2) 小感冒：再單看 MAE 隨時間圖（是否有明顯波動不同的區間，但你持有時間太長，這步驟要打折扣）

(3) 流行性感冒：在分別單看 MAE 與 MFE 圖（目前你的 Case 卡在這關）

(3) 腸胃炎：再看 MAE 對 MFE 圖（目前你的 Case 卡在這關）

(4) 慢性病：MAE 與 MFE 沒有明顯團狀聚集，而是呈現帶狀 -> 動態停損，提高 Win Ratio

(5) 休克急診：在 Win Ratio 提高下，應該各項指標都會變高/或變低，假如都不好，就要控制持有時間

步驟越後面的，他的併發症和要考慮的各種因素更錯綜複雜，不是我不願意給你一個原則，而是我的經驗是，不同交易員的性格，和他採取的策略，在交易結果上體現出來的狀況都會不同，開刀的角度和順序有時候也會不一樣。

</br>

**3. 回測（保留測試資料）**

要的，這其實是我在上次演講中沒有提到的，你到時候就要把滾動過程的各項指標，在訓練集和測試集畫 X，Y 圖

來避免 Over-fitting  : 

![image.png](https://i.imgur.com/RONOE9y.png)

通常越近的年份或滾動越新的，我們在畫圖上顏色會越深，越久以前滾動的顏色會越淺（或是相反色系）。

理想情況應該會是有一個好的區間（例如你的策略和滾動方式，可能在訓練集 RF 8 - 10 測試能維持 3-5 之類的）。

這通常不會太漂亮，但是如果你 Over fitting 就會非常明顯，通常是在進來的訊號就過度優化，後許資金管理能動的空間不大。

你的狀況比較特殊，你是因為交易次數太少，所以可能得先提高勝率在來看 Over fitting。

</br>

**4. 基本分析要不要滾動回測**

這是一個好問題，我是認為如果你持有時間很長，同時市場波動不會是你太嚴格進出場的參考依據的話，我會覺得可能還好。

但是我認為你至少要能判斷你的策略的波動適應情況，例如你的策略就蠻明顯的，你可以去找基本面支撐波動的理由（例如整體經濟/金融危機等）。

如果你能證明這段時間持有這麼大的波動程度是我無法預測也可接受的，那就不用滾動是 ok 的。

當然你知道，凡事都要 deps on 狀況，所以我也不會把話說死，但是至少看你這個 Case 來說，可能不滾動是還好（滾了交易次數也不會變多）

</br>

**疑惑 1. p109 的 MAE 頻率圖**

是所有的 MAE 一起算，所以無論輸錢贏錢的都一起算，很重要的原因是因為你如果調整 Stoploss，你的輸錢交易和贏錢交易都應該一起被影響。

你剛剛前面那個頻率圖其實是講錯了，那應該純粹是 MAE 對 Porfit Loss 的圖，沒有頻率關係，因為你也沒有統計多少個。

你應該選一個 bin size 而不是全部畫出來，舉例來說你可以用 0.005 當做一個區間。

統計 MAE 在 [0，0.005] 有幾個，[0.005，0.01] 有幾個... 類似這樣，然後畫 Bar Plot，才會看出單峰雙峰的問題

這樣才是 MAE 頻率圖。

</br>

**疑惑 2. MAE 對 MFE 的圖怎麼畫**

**疑！！你不是有算 MAE 和 MFE ，在你的 csv 有耶..... 可能是 GitHub 上面還沒有新增**

這就很簡單，就從你的 Excel 轉過來：

![image.png](https://i.imgur.com/xkM8sDk.png)

PnL 不用畫沒關係，但你因為持有太長，可能可以畫出來看看特徵 **（這可能可以找出你財報對應的 MAE/MFE 的統計規律）**。

PnL 那個圖只是示意圖，讓你根據你的 MAE/ MFE 來大致猜測這筆交易持有期間的損益狀況。

但因為你持有時間比較長，我覺得 PnL 那個圖在我的這套方法中參考性可能不太高...... 

</br>

**3. MAE MFE 圖比較進階，找不到合適停損點才會看嗎？**

基本上是對的，我因為太老手了...... 所以我現在基本上只看 MAE MFE 圖，剛入門單看 MAE 和 MFE 其實就蠻夠的。

最主要是要看有沒有單峰，雙峰就很麻煩，雙峰代表你的策略在還沒賺錢之前連波動都無法應對好。

通常基本的技術指標大概都能處理一定程度的波動性，所以如果 MAE MFE 雙峰就代表你的策略可能比技術指標還差。

當然因為你是用財報，我覺得這是一塊新大陸，MAE MFE 的圖可能解釋上會有不同看法也說不定!!!!!（非常有趣!!! 可能可以走出新的一套理論出來，但交易次數不夠可能還是 MAE/MFE Apply不給力的主因）

</br>

**4. 演講中提到監督式學習考量 loss function 不只是 error term 和 RL 的差別**

你問到一個非常非常好的問題，基本上監督式學習就算你在 loss function 去調，你的順序性還是會不夠明顯，但是你可以快速而大量的訓練出許多模型。

舉例來說，我可以有一個 loss function 是 error - 0.01 *  return ，這在 GAN 經常會使用到，那個 0.01 就是 lambda。

所以當我的 return 徘迴在 -1 ~ 1 之間時，我的 error 如果沒有小到 0.01 以下，我的 return 那項對 loss function 影響力根本不夠。

例如 Apple 在產生假的眼睛圖片時，他就會有一個 term 是判斷眼睛看的方向，如果 error 足夠小之後，眼睛應該看像四周而不是直直瞪著你。

</br>

所以 RL 和一般監督式學習+loss function 考量其他因素（根據 loss 改 weights），首先最大的差別是對 objective function（目標函數）的順序性。

在監督式學習不用倒傳遞，你的 loss function 順序性是隱式的，但在 RL 裡面是顯式的。

在 RL 由於你可以定義你的狀態，以及在不同狀態底下我應該要採取什麼行動，所以我的學習是可以分層的（也就是蠻有名的 HRL）

例如說，機器人走路如果跌倒最優先要先站起來，所以機器人在衡量前進時最優先得衡量會不會跌倒，在這個前提下在考慮我能不能往目標邁進。

換句話說，如果我把我要達成的目標分成不同的階段，這些階段對應的狀態也更加明顯時，就能達到和 ML 的隱式的順序性不同，我可以強迫他得優先先符合某個條件。

而這個條件是依賴某個情況的下的狀態（也就是有時間關係）而在 ML 中你是沒有時間關係，你會打亂你的 Batch 然後隨意去跑（當然RNN是另外一件事，但基本上前後仍然不影響）。

所以 RL 訓練起來會太慢，或是每次訓練過程中的 bias（偏差）也會比 ML 來得高（可能某種狀態在某一種學習方向下，都完全不會發生，所謂的 RL 怪異行為）

我個人是支持 RL 的，因為資金管理整套是完全可以用 RL 實現狀態轉換（我現在處於當前損益的什麼狀態呢？我目前的報酬和 PnL 和交易的統計數字，應該要影響我當下的決定）

我自己公司也在兩年前大概做完了這部分的套件，狀況用的還可以，只是活的時間不太長，因為詭異行為太多，還找不到方法解釋，這部分我有和台大資工的一個老師在合作，他們會往這部份去找看看學理依據，大概是如此。

順序！時間！是兩個最大的差異。